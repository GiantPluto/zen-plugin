//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
// Zen Plugin Framework
//
// Copyright (C) 2001 - 2018 Raymond A. Richards
//
//  This software is provided 'as-is', without any express or implied
//  warranty.  In no event will the authors be held liable for any damages
//  arising from the use of this software.
//
//  Permission is granted to anyone to use this software for any purpose,
//  including commercial applications, and to alter it and redistribute it
//  freely, subject to the following restrictions:
//
//  1. The origin of this software must not be misrepresented; you must not
//     claim that you wrote the original software. If you use this software
//     in a product, an acknowledgment in the product documentation would be
//     appreciated but is not required.
//  2. Altered source versions must be plainly marked as such, and must not be
//     misrepresented as being the original software.
//  3. This notice may not be removed or altered from any source distribution.
//
//  Tony Richards trichards@indiezen.com
//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~

#include "Extension.hpp"

#include "PluginManager.hpp"
#include "PluginInfo.hpp"

#include <Zen/PluginI_Plugin.hpp>

#include <Zen/Core/Threading/MutexFactory.hpp>
#include <Zen/Core/Threading/CriticalSection.hpp>

#include <Zen/Core/Utility/runtime_exception.hpp>

//#include <stdexcept>
#include <iostream>

#include <stddef.h>

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
namespace Zen::Plugin {
//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~

Extension::Extension(const I_ConfigurationElement& _config, PluginInfo& _pluginInfo)
:   m_configuration(_config)
,   m_pluginInfo(_pluginInfo)
,   m_pClassFactory(NULL)
,   m_pGuard(Threading::MutexFactory::create())
{
    m_extensionPointId = _config.getAttribute("point");
    m_type = _config.getAttribute("type");
}

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
Extension::~Extension()
{
    Threading::MutexFactory::destroy(m_pGuard);
}

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
I_ClassFactory&
Extension::getClassFactory()
{
    if (m_pClassFactory == NULL)
    {
        Threading::CriticalSection lock(m_pGuard);
        if (m_pClassFactory == NULL)
        {
            // Call getClassFactory to get the class factory.  This is implemented
            // by the plugin inside the .dll or .so
            std::shared_ptr<I_Plugin> pPlugin = m_pluginInfo.getPlugin();
            if (pPlugin.get() == NULL)
            {
                throw Zen::Utility::runtime_exception("Extension::getClassFactory(): Error loading the plugin.");
            }
            else
            {
                m_pClassFactory = pPlugin->getClassFactory(m_configuration);
            }
        }
    }

    if (m_pClassFactory == NULL)
    {
        // TODO Make this exception more descriptive
        throw Zen::Utility::runtime_exception("Extension::getClassFactory(): Error getting the class factory.");
    }

    return *m_pClassFactory;
}

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
const I_ConfigurationElement&
Extension::getConfigurationElement() const
{
    return m_configuration;
}

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
const std::string&
Extension::getType() const
{
    return m_type;
}

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
PluginInfo&
Extension::getPluginInfo()
{
    return m_pluginInfo;
}

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
const PluginInfo&
Extension::getPluginInfo() const
{
    return m_pluginInfo;
}

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
const std::string&
Extension::getExtensionPointId() const
{
    return m_extensionPointId;
}

//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
}   // namespace Zen::Plugin
//-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~-~
